<div class="blindbox">
    <div class="bb-factory">
        <ul>
            <li balance>合约工厂余额：<span>...</span>ETH</li>
            <li withdraw><a>提现</a></li>
        </ul>
    </div>
    <div class="bb-create">
        <ul class="bb-form">
            <!-- <li selector><select name="account-selector">
                    <option value=""></option>
                </select></li> -->
            <ul class="bb-pay">
                <li><input type="radio" id="annualFee" name="payMode" value="1" checked />
                    <label for="annualFee">年费</label>
                </li>
                <li><input type="radio" id="monthlyFee" name="payMode" value="2" />
                    <label for="monthlyFee">月费</label>
                </li>
            </ul>
            <li amount><span>3</span>eth</li>
            <li lucky><input placeholder="输入盲盒幸运数个数"></li>
            <li req><a style="cursor: pointer;text-decoration: underline;">申请创建盲盒</a></li>
        </ul>
        <ul class="bb-details"></ul>
    </div>

    <div class="bb-use">
        <ul class="bb-sel">
            <li class="bb-tt">盲盒列表</li>
            <li class="bb-dealer"><label>经营者</label><select>
                    <option value="@@">未选择</option>
                </select></li>
            <li class="bb-contract"><label>合约</label><select>
                    <option value="@@">未选择</option>
                </select>
            </li>
            <li class="bb-view"><a style="cursor: pointer;text-decoration: underline;">刷新</a></li>
        </ul>
        <ul class="bb-panel" style="display: none;">
            <li>
                <ul class="bb-details">
                    <li class="bb-dls" state>
                        <p><label>状态</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" isRunning>
                        <p><label>启/停</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" balance>
                        <p><label>奖池</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" luckyCount>
                        <p><label>幸运数个数</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" odds title="即当前奖池*赔率即为可能得到的钱">
                        <p><label>奖池赔率</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" bonus>
                        <p style="color: red;"><label>可发放奖金</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" kickbackRate>
                        <p><label>手续费率</label><span>xxx</span></p>
                        <ul>
                            <li class="bb-dls" brokerageRate>
                                <p><label>经营者分账比</label><span>xxx</span></p>
                            </li>
                            <li class="bb-dls" taxRate>
                                <p><label>平台分账比</label><span>xxx</span></p>
                            </li>
                        </ul>
                    </li>
                    <li class="bb-dls" kickbackFunds>
                        <p><label>总手续费</label><span>xxx</span></p>
                        <ul>
                            <li class="bb-dls" brokerageFunds>
                                <p><label>经营者所得</label><span>xxx</span></p>
                            </li>
                            <li class="bb-dls" taxFunds>
                                <p><label>平台所得</label><span>xxx</span></p>
                            </li>
                        </ul>
                    </li>

                    <li class="bb-dls" betFunds>
                        <p style="color: red;"><label>玩家需下注</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" income>
                        <p style="color: red;"><label>玩家可赢收</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" benefitRate>
                        <p style="color: red;"><label>玩家收益率</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" blindHash>
                        <p><label>盲盒Hash</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" betHash>
                        <p><label>下注Hash</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" root>
                        <p><label>平台地址</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" dealer>
                        <p><label>经营者地址</label><span>xxx</span></p>
                    </li>
                    <li class="bb-dls" player>
                        <p><label>玩家地址</label><span>xxx</span></p>
                    </li>
                </ul>
            </li>
            <li>
                <p class="bb-feed"><a style="cursor: pointer;">饲喂</a></p>
                <ul class="bb-input">
                    <li luckyNumber><input placeholder="输入幸运号"></li>
                    <li nonce><input placeholder="输入nonce"></li>
                </ul>
                <ul class="bb-ul">
                    <li class="bb-li" foldBlindBox>
                        <a button>扪盒</a>
                    </li>
                    <li class="bb-li" placeBet>
                        <a button>下注</a>
                    </li>
                    <li class="bb-li" lottery>
                        <a button>开奖</a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="mask" style="display: none;">
        <div class="dialog">
            <p amount>你需支付注金<span>2.34</span>ETH</p>
            <select accounts>
                <option>选择付款账户</option>
            </select>
            <ul ops>
                <li yes><a>确认支付</a></li>
                <li no><a>取消支付</a></li>
            </ul>
            <p tips><span></span></p>
        </div>
    </div>
</div>
<link href="/css/blindbox.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.0.1-alpha.5/web3.min.js"
    integrity="sha512-NfffVWpEqu1nq+658gzlJQilRBOvjs+PhEKSjT9gkQXRy9OfxI2TOXr33zS7MgGyTpBa5qtC6mKJkQGd9dN/rw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $(document).ready(async function () {
        const web3 = new Web3(window.ethereum);

        $('.bb-factory ul li[withdraw] a').click(function () {
            $.get('/api/blindbox.withdraw', {}, function (data) {
                refreshBalance();
            });
        })
        var tempAmountE = $('.bb-form li[amount]').clone();
        $('.bb-form li[req] a').click(async function () {
            var luckyCount = $('.bb-form li[lucky] input').val();
            if (luckyCount == '' || typeof luckyCount == 'undefined') {
                alert('幸运数字为空');
                return;
            }
            var fee = $('.bb-form li[amount]').attr('amount');
            if (typeof fee == "undefined" || fee == '') {
                alert('费用为空');
                return;
            }
            var contractAddress = $('.bb-form li[amount]').attr('contractAddress');
            if (typeof contractAddress == "undefined" || contractAddress == '') {
                alert('合约地址为空');
                return;
            }
            var payMode = $('.bb-pay input[name="payMode"]:checked').val();
            $('.mask .dialog p[amount]').attr('amount', fee);
            $('.mask .dialog p[amount]').attr('contractAddress', contractAddress);
            $('.mask .dialog p[amount]').attr('payMode', payMode);
            $('.mask .dialog p[amount] span').html(fee);
            $('.mask .dialog p[luckyCount]').remove();
            $('.mask .dialog').prepend("<p luckyCount='" + luckyCount + "'>幸运数字个数:<span>" + luckyCount + "</span></p>");
            const accounts = await web3.eth.requestAccounts();
            var selectE = $('.mask .dialog select');
            selectE.empty();
            selectE.append("<option value='@@'>选择付款账户</option>");
            for (var i = 0; i < accounts.length; i++) {
                var account = accounts[i];
                selectE.append("<option value='" + account + "'>" + account + "</option>");
            }
            $('.mask .dialog p[tips] span').empty();
            $('.mask').attr('itfor', 'create');
            $('.mask').show();
            tempAmountE = $('.bb-form li[amount]').clone();
        })

        $('.blindbox').undelegate('.mask[itfor="create"] .dialog select', 'change');
        $('.blindbox').delegate('.mask[itfor="create"] .dialog select', 'change', function () {
            var dealer = $(this).val();
            if ('@@' == dealer) {
                return;
            }
            $.get('/api/blindbox.isValidDealer', { dealer: dealer }, function (data) {
                var isValidDealer = 'true' == data;
                var amountE = $('.mask[itfor="create"] .dialog p[amount]');
                amountE.attr('isValidDealer', isValidDealer);
                if (isValidDealer) {
                    amountE.empty();
                    amountE.append("<span style='font-size:12px;'>所选账户已是有效的付费会员，点确认按钮不会扣款</span>");
                } else {
                    amountE.empty();
                    amountE.append("你需支付注金" + tempAmountE.html());
                }
            });
        });
        $('.blindbox').undelegate('.mask[itfor="create"] .dialog ul[ops] li[yes]', 'click');
        $('.blindbox').delegate('.mask[itfor="create"] .dialog ul[ops] li[yes]', 'click', async function () {
            var isValidDealer = $('.mask[itfor="create"] .dialog p[amount]').attr('isValidDealer');
            var dealer = $('.mask .dialog select').val();
            if ('@@' == dealer) {
                return;
            }
            //无效则需要付款
            if ("true" != isValidDealer) {
                var amount = $('.mask .dialog p[amount]').attr('amount');
                if (typeof amount == "undefined" || amount == '') {
                    alert('金额为空');
                    return;
                }
                var contractAddress = $('.mask .dialog p[amount]').attr('contractAddress');
                if (typeof contractAddress == "undefined" || contractAddress == '') {
                    alert('合约地址为空');
                    return;
                }
                var payMode = $('.mask .dialog p[amount]').attr('payMode');
                if (typeof payMode == "undefined" || payMode == '') {
                    alert('付款方式为空');
                    return;
                }

                const amountWei = web3.utils.toWei(amount, "ether");
                const transaction = {
                    from: dealer,
                    to: contractAddress,
                    value: amountWei,
                    // nonce: Math.floor((Math.random()*100000)+1)
                };
                switch (payMode) {
                    case '1':
                        break;
                    case '2':
                        transaction.data = web3.eth.abi.encodeFunctionSignature('recMothlyFee()');
                        break;
                }
                // Send the transaction
                var result;
                try {
                    result = await web3.eth.sendTransaction(transaction);
                } catch (err) {
                    // Handle error
                    $('.mask .dialog p[tips] span').html(err);
                    console.error("Failed to send transaction:", err);// Update status
                    return;
                }
            }

            var luckyCount = $('.mask .dialog p[luckyCount]').attr('luckyCount');
            if (typeof luckyCount == "undefined" || luckyCount == '') {
                alert('幸运数字为空');
                return;
            }
            $('.mask').hide();
            refreshBalance();
            $.get('/api/blindbox.create', { dealer: dealer, luckyCount: luckyCount }, function (data) {
                var obj = JSON.parse(data);
                $('.bb-create .bb-details').append("<li>" + obj.contractAddress + "</li>");
                $('.bb-dealer select').empty();
                $('.bb-dealer select').append('<option value="@@">未选择</option>');
                refreshDealerList();
            });
        });
        function refreshBalance() {
            $.get('/api/blindbox.getBalance', {}, function (data) {
                console.log(data);
                $('.bb-factory li[balance] span').html(data);
            });
        }
        refreshBalance();
        function refreshPayPanel() {
            var payMode = $('.bb-pay input[name="payMode"]:checked').val();
            if (typeof payMode == "undefined" || payMode == '') {
                return;
            }
            $('.bb-form li[amount] span').html('...');
            $.get('/api/blindbox.getFeeInfo', { payMode: payMode }, function (data) {
                console.log(data);
                var obj = JSON.parse(data);
                $('.bb-form li[amount] span').html(obj.fee + '');
                $('.bb-form li[amount]').attr('amount', obj.fee + '');
                $('.bb-form li[amount]').attr('contractAddress', obj.address + '');
            });
        }
        refreshPayPanel();
        $('.bb-pay input[name="payMode"]').change(function () {
            refreshPayPanel();
        })
        function refreshDealerList() {
            $.get('/api/blindbox.dealers', {}, function (data) {
                console.log(data);
                var arr = JSON.parse(data);
                for (var i = 0; i < arr.length; i++) {
                    var address = arr[i];
                    $('.bb-dealer select').append("<option value='" + address + "'>" + address + "</option>");
                }
            });
        }

        refreshDealerList();

        $('.bb-dealer select').change(function () {
            $('.bb-contract select').empty();
            var selector = $(this);
            var val = selector.val();
            $.get('/api/blindbox.contracts', { dealer: val }, function (data) {
                console.log(data);
                var arr = JSON.parse(data);
                for (var i = 0; i < arr.length; i++) {
                    var address = arr[i];
                    $('.bb-contract select').append("<option value='" + address + "'>" + address + "</option>");
                }
                refreshDetails();
            });
        });
        $('.bb-contract select').change(function () {
            refreshDetails();
        })
        $('.bb-view a').click(function () {
            refreshDetails();
        });
        function toState(state) {
            switch (state) {
                case '0':
                    return '已扪盒';
                case '1':
                    return '等待下注';
                case '2':
                    return '已下注';
                case '3':
                    return '正在开奖';
                case '4':
                    return '已开奖';
            }
        }
        function refreshDetails() {
            $('.bb-panel').show();
            var dealer = $('.bb-dealer select').val();
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            $.get('/api/blindbox.details', { dealer: dealer, address: address }, function (data) {
                var obj = JSON.parse(data);
                console.log(obj);
                var ul = $('.bb-details');
                ul.find('li[state] span').html(toState(obj.state));
                ul.find('li[luckycount] span').html(obj.luckyCount);
                ul.find('li[odds] span').html(obj.odds / 100.00);
                ul.find('li[kickbackRate] span').html(obj.kickbackRate / 100.00);
                ul.find('li[brokeragerate] span').html(obj.brokerageRate / 100.00);
                ul.find('li[taxrate] span').html(obj.taxRate / 100.00);
                ul.find('li[benefitRate] span').html(obj.benefitRate / 100.00);
                ul.find('li[blindhash] span').html(obj.blindHash);
                ul.find('li[betHash] span').html(obj.betHash);
                ul.find('li[root] span').html(obj.root);
                ul.find('li[dealer] span').html(obj.dealer);
                ul.find('li[player] span').html(obj.player);
                ul.find('li[balance] span').html(obj.balance);
                ul.find('li[betFunds] span').html(obj.betFunds);
                ul.find('li[betFunds]').attr("betFunds", obj.betFunds);
                ul.find('li[bonus] span').html(obj.bonus);
                ul.find('li[kickbackFunds] span').html(obj.kickbackFunds);
                ul.find('li[brokerageFunds] span').html(obj.brokerageFunds);
                ul.find('li[taxFunds] span').html(obj.taxFunds);
                ul.find('li[income] span').html(obj.income);
                ul.find('li[isRunning] span').html(obj.isRunning ? '正在运行' : '已停止');

                var op = $('.bb-ul');
                switch (obj.state) {
                    case '4':
                        op.find('li').hide();
                        op.find('li[foldBlindBox]').show();
                        break;
                    case '0':
                        op.find('li').hide();
                        op.find('li[placeBet]').show();
                        break;
                    case '2':
                        op.find('li').hide();
                        op.find('li[lottery]').show();
                        break;
                }
            });
        }
        $('.bb-details .bb-dls[isRunning] span').click(function () {
            var dealer = $('.bb-dealer select').val();
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            $.get('/api/blindbox.toggleRunning', { address: address, dealer: dealer }, function (data) {
                refreshDetails();
            })
        })
        $('.bb-ul li[foldBlindBox] a').click(function () {
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            var luckyNumber = $('.bb-input li[luckyNumber] input').val();
            var nonce = $('.bb-input li[nonce] input').val();
            if (luckyNumber == '' || nonce == '') {
                alert('空');
            }
            
            $.get('/api/blindbox.foldBlindBox', { address: address, luckyNumber: luckyNumber, nonce:nonce}, function (data) {
                refreshDetails();
            })
        })
        $('.bb-ul li[placeBet] a').click(async function () {
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            var luckyNumber = $('.bb-input li[luckyNumber] input').val();
            var nonce = $('.bb-input li[nonce] input').val();
            if (luckyNumber == '' || nonce == '') {
                alert('空');
            }
            var betFunds = $('.bb-details li[betFunds]').attr('betFunds');
            $('.mask .dialog p[amount] span').html(betFunds);
            const accounts = await web3.eth.requestAccounts();
            var selectE = $('.mask .dialog select');
            selectE.empty();
            selectE.append("<option value='@@'>选择付款账户</option>");
            for (var i = 0; i < accounts.length; i++) {
                var account = accounts[i];
                selectE.append("<option value='" + account + "'>" + account + "</option>");
            }
            $('.mask .dialog p[tips] span').empty();
            $('.mask').attr('itfor', 'bet');
            $('.mask').show();

        });
        $('.mask .dialog ul[ops] li[no]').click(function () {
            $('.mask').hide();
        });
        $('.blindbox').undelegate('.mask[itfor="bet"] .dialog ul[ops] li[yes]', 'click');
        $('.blindbox').delegate('.mask[itfor="bet"] .dialog ul[ops] li[yes]', 'click', async function () {
            var betFunds = $('.bb-details li[betFunds]').attr('betFunds');
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            var player = $('.mask .dialog select').val();
            if ('@@' == player) {
                return;
            }
            const amountWei = web3.utils.toWei(betFunds, "ether");
            const transaction = {
                from: player,
                to: address,
                value: amountWei,
                // nonce: Math.floor((Math.random()*100000)+1)
            };
            // Send the transaction
            var result;
            try {
                result = await web3.eth.sendTransaction(transaction);
            } catch (err) {
                // Handle error
                $('.mask .dialog p[tips] span').html(err);
                console.error("Failed to send transaction:", err);// Update status
                return;
            }
            refreshDetails();
            console.log("Transaction result:", result);
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            var luckyNumber = $('.bb-input li[luckyNumber] input').val();
            var nonce = $('.bb-input li[nonce] input').val();
            if (luckyNumber == '' || nonce == '') {
                alert('空');
            }
            $.get('/api/blindbox.placeBet', { address: address, player: player, luckyNumber: luckyNumber, nonce: nonce }, function (data) {
                $('.mask').hide();
                refreshDetails();
            })
        });

        $('.bb-ul li[lottery] a').click(function () {
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            var luckyNumber = $('.bb-input li[luckyNumber] input').val();
            var nonce = $('.bb-input li[nonce] input').val();
            if (luckyNumber == '' || nonce == '') {
                alert('空');
            }
            $.get('/api/blindbox.lottery', { address: address, luckyNumber: luckyNumber, nonce: nonce }, function (data) {
                refreshDetails();
            })
        });
        $('.bb-feed a').click(function () {
            var input = prompt("输入金额ether", "0.1");
            if (input == null) {
                return;
            }
            var address = $('.bb-contract select').val();
            if ('@@' == address) {
                return;
            }
            var dealer = $('.bb-dealer select').val();
            $.get('/api/blindbox.onfeed', { address: address }, async function (data) {
                const amountWei = web3.utils.toWei(input, "ether");
                const transaction = {
                    from: dealer,
                    to: address,
                    value: amountWei,
                    data: web3.eth.abi.encodeFunctionSignature('feed()')
                    // nonce: Math.floor((Math.random()*100000)+1)
                };
                // Send the transaction
                try {
                    const result = await web3.eth.sendTransaction(transaction);
                    refreshDetails();
                    console.log("Transaction result:", result);
                } catch (err) {
                    // Handle error
                    console.error("Failed to send transaction:", err);// Update status
                }
            })
        });
    });
</script>